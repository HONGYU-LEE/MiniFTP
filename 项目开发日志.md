<h1 align=center> MiniFtp 项目 开发日志 </h1>

[TOC]

# 2020_7_26



## 一、开发环境搭建

>### 1、安装FTP服务器vsftpd
>
>```
>yum install vsftpd -y
>```
>
>### 2、启动vsftpd
>
>```
>systemctl status vsftpd
>systemctl start  vsftpd
>systemctl stop   vsftpd
>systemctl restart vsftpd
>修改配置文件
>修改 /etc/vsftpd/vsftpd.conf
>```
>
>### 3、安装FTP客户端工具
>
>Linux平台——lftp
>
>```
>yum install lftp -y
>```
>
>Windows平台——Leapftp

## 二、系统框架搭建

> ### 1、创建公共模块common
>
> ```c++
> #ifndef _COMMON_H_
> #define _COMMON_H_
> 
> #include<unistd.h>
> #include<stdio.h>
> #include<string.h>
> #include<stdlib.h>
> #include<assert.h>
> 
> #include<sys/socket.h>
> #include<netinet/in.h>
> #include<arpa/inet.h>
> 
> #define MAX_BUFFER_SIZE 1024
> 
> #define ERR_EXIT(msg) \
> 	do\
> 	{\
> 		perror(msg);\
> 		exit(EXIT_FAILURE);\
> 	}while (0)
> 
> #endif /* __COMMON_H_ */
> ```
>
> 
>
> ### 2、创建网络模块sysutil
>
> ```c++
> #include"sysutil.h"
> 
> int tcp_server(const char* ip, unsigned short port)
> {
> 	int lst_fd;
> 	
> 	if((lst_fd = socket(AF_INET, SOCK_STREAM, 0)) < 0)
> 	{
> 		ERR_EXIT("socket");
> 	}
> 
> 	struct sockaddr_in addr;
> 	addr.sin_family = AF_INET;
> 	addr.sin_port = htons(port);
> 	addr.sin_addr.s_addr = inet_addr(ip);
> 	
> 	int on = 1;
> 	if(setsockopt(lst_fd, SOL_SOCKET, SO_REUSEADDR, &on, sizeof(on)) < 0)
> 	{
> 		ERR_EXIT("setsockopt");
> 	}
> 
> 	if(bind(lst_fd, (struct sockaddr*)&addr, sizeof(addr)) < 0)
> 	{
> 		ERR_EXIT("bind");
> 	}
> 
> 	if(listen(lst_fd, SOMAXCONN) < 0)
> 	{
> 		ERR_EXIT("listen");
> 	}
> 
> 	return lst_fd;
> }
> 
> ```
>
> 
>
> ### 3、创建会话模块session
>
> ```c++
> #include"session.h"
> #include"ftpproto.h"
> #include"privparent.h"
> 
> void session_start(session_t* sess)
> {
> 	pid_t pid = fork();
> 
> 	if(pid == - 1)
> 	{
> 		ERR_EXIT("fork");
> 	}
> 
> 	if(pid == 0)
> 	{
> 		//ftp服务进程
> 		handle_child(sess);
> 	}
> 	else
> 	{
> 		//nobody进程
> 		handle_parent(sess);
> 	}
> }
> ```
>
> 
>
> ### 4、创建FTP服务进程模块ftpproto
>
> ```c++
> #include"ftpproto.h"
> 
> void ftp_reply(session_t* sess, int num, char* msg)
> {
> 	char buf[MAX_BUFF_SIZE] = { 0 };
> 	sprintf(buf, "%d %s \n\r", num, msg);
> 
> 	send(sess->ctl_fd, buf, MAX_BUFF_SIZE, 0);
> }
> 
> void handle_child(session_t* sess)
> {
> 	while(1)
> 	{
> 		//等待客户端命令，并进行处理
> 	}
> }
> ```
>
> 
>
> 
>
> ### 5、创建nobody进程模块privparent
>
> ```c++
> #include"privparent.h"
> 
> void handle_parent(session_t* sess)
> {
> 	while(1)
> 	{
> 		//等待ftp进程消息
> 	}
> }
> ```
>
> 
>
> 
>
> ### 6、创建主进程模块MiniFTP
>
> ```c++
> #include"common.h"
> #include"session.h"
> #include"sysutil.h"
> 
> int main(int agrc, char* argv[])
> {
> 	session_t sess = { -1 };
> 
> 	int lst_sock = tcp_server("192.168.0.128", 9188); 
> 
> 	int new_sock;
> 	struct sockaddr_in addr;
> 	socklen_t addrlen;
> 	
> 	while(1)
> 	{
> 		if((new_sock = accept(lst_sock, (struct sockaddr*)&addr, &addrlen)) < 0)
> 		{
> 			ERR_EXIT("accept");
> 		}
> 
> 		pid_t pid = fork();
> 
> 		if(pid == -1)
> 		{
> 			ERR_EXIT("fork");
> 		}
> 		
> 		if(pid == 0)
> 		{
> 			//子进程
> 			close(lst_sock);
> 			//子进程创建会话
> 			sess.ctl_fd = new_sock;
> 			session_start(&sess);
> 			exit(EXIT_SUCCESS);
> 		}
> 		else
> 		{
> 			//父进程
> 			close(new_sock);
> 		}
> 	}
> 
> 	close(lst_sock);
> 	return 0;
> }
> 
> 
> ```
>
> 
>
> ### 7、创建MakeFile文件
>
> ```makefile
> CC = gcc
> CFLAGS = -g
> OBJS = sysutil.o session.o ftpproto.o privparent.o MiniFTP.o
> LIBS = 
> BIN  = MiniFTP
> 
> $(BIN):$(OBJS)
> 	$(CC) $(CFLAGS) $^ -o $@ $(LIBS)
> %.o:%.c
> 	$(CC) $(CFLAGS) -c $< -o $@
> 
> .PHONY:clean
> clean:
> 	rm -fr *.o $(BIN)
> ```
>
> 

---------------------------------------

